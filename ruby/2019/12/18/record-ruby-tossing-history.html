<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>折腾 ruby 的一些日常记录 | A tossing programmer</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="折腾 ruby 的一些日常记录" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="2019-12-18   突然发现 gem update --system 没有作用了，系统环境是 Ubuntu 18.04.3 LTS。 一开始是因为遇到了 Cant find gem bundler (&gt;= 0.a) with executable bundle 的问题。查看了下当前环境中的 gem 版本，是 2.7.7。很显然，解决问题的关键始终是升级。不过运行了 gem update --system 后，系统却告知已经是最新版本。 root&gt; gem update --system Latest version already installed. Done.   既然已经不能使用默认的方式升级，只能指定版本了 gem update --system &#39;3.0.6&#39;，经过一系列安装后，升级成功。" />
<meta property="og:description" content="2019-12-18   突然发现 gem update --system 没有作用了，系统环境是 Ubuntu 18.04.3 LTS。 一开始是因为遇到了 Cant find gem bundler (&gt;= 0.a) with executable bundle 的问题。查看了下当前环境中的 gem 版本，是 2.7.7。很显然，解决问题的关键始终是升级。不过运行了 gem update --system 后，系统却告知已经是最新版本。 root&gt; gem update --system Latest version already installed. Done.   既然已经不能使用默认的方式升级，只能指定版本了 gem update --system &#39;3.0.6&#39;，经过一系列安装后，升级成功。" />
<link rel="canonical" href="https://fuzhibo.site/ruby/2019/12/18/record-ruby-tossing-history.html" />
<meta property="og:url" content="https://fuzhibo.site/ruby/2019/12/18/record-ruby-tossing-history.html" />
<meta property="og:site_name" content="A tossing programmer" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-18T14:18:29+08:00" />
<script type="application/ld+json">
{"description":"2019-12-18   突然发现 gem update --system 没有作用了，系统环境是 Ubuntu 18.04.3 LTS。 一开始是因为遇到了 Cant find gem bundler (&gt;= 0.a) with executable bundle 的问题。查看了下当前环境中的 gem 版本，是 2.7.7。很显然，解决问题的关键始终是升级。不过运行了 gem update --system 后，系统却告知已经是最新版本。 root&gt; gem update --system Latest version already installed. Done.   既然已经不能使用默认的方式升级，只能指定版本了 gem update --system &#39;3.0.6&#39;，经过一系列安装后，升级成功。","mainEntityOfPage":{"@type":"WebPage","@id":"https://fuzhibo.site/ruby/2019/12/18/record-ruby-tossing-history.html"},"@type":"BlogPosting","url":"https://fuzhibo.site/ruby/2019/12/18/record-ruby-tossing-history.html","headline":"折腾 ruby 的一些日常记录","datePublished":"2019-12-18T14:18:29+08:00","dateModified":"2019-12-18T14:18:29+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://fuzhibo.site/feed.xml" title="A tossing programmer" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">A tossing programmer</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">折腾 ruby 的一些日常记录</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-12-18T14:18:29+08:00" itemprop="datePublished">Dec 18, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h3 id="2019-12-18">2019-12-18</h3>
<p>  突然发现 <code class="highlighter-rouge">gem update --system</code> 没有作用了，系统环境是 <code class="highlighter-rouge">Ubuntu 18.04.3 LTS</code>。 一开始是因为遇到了 <a href="https://bundler.io/blog/2019/05/14/solutions-for-cant-find-gem-bundler-with-executable-bundle.html">Cant find gem bundler (&gt;= 0.a) with executable bundle</a> 的问题。查看了下当前环境中的 gem 版本，是 <code class="highlighter-rouge">2.7.7</code>。很显然，解决问题的关键始终是升级。不过运行了 <code class="highlighter-rouge">gem update --system</code> 后，系统却告知已经是最新版本。</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root&gt;</span><span class="w"> </span>gem update <span class="nt">--system</span>
<span class="go">Latest version already installed. Done.
</span></code></pre></div></div>
<p>  既然已经不能使用默认的方式升级，只能指定版本了 <code class="highlighter-rouge">gem update --system '3.0.6'</code>，经过一系列安装后，升级成功。</p>

<hr />
<h3 id="2019-12-19">2019-12-19</h3>
<p>  因为需要 jekyll 支持更多的功能，于是开始折腾 jekyll plugins 的开发，在进行开发之前第一步自然是要学会打包。这个打包的步骤如下（参考这个<a href="https://ruby-china.org/topics/26292">博客</a>）：</p>
<h4 id="使用-bundler-开始工作">使用 bundler 开始工作</h4>
<p>  前几年，都还是用 <code class="highlighter-rouge">gem + rails</code> 这些组合来构建包：</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>gem <span class="nb">install </span>rails  //安装rails
<span class="gp">$</span><span class="w"> </span>gem <span class="nb">install </span>rails <span class="nt">-v</span> 4.2.0   //安装指定版本的rails
<span class="gp">$</span><span class="w"> </span>gem search rails  //查找所有名称中含有rails的gem
<span class="gp">$</span><span class="w"> </span>gem search ^rails  //查找所有名称中以rails开头的gem
<span class="gp">$</span><span class="w"> </span>gem search ^rails <span class="nt">-d</span>  //查找所有名称中以rails开头的gem，并显示描述
<span class="gp">$</span><span class="w"> </span>gem build package.gemspec  //构建一个gem，就是把你自己写的gem源码，打包成一个.gem文件
<span class="gp">$</span><span class="w"> </span>gem push pack-1.0.gem  //发布到源上，默认是rubygems.org
</code></pre></div></div>
<p>  现在，可以使用 bundler 搞定一切：</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>bundler gem mygem
<span class="go">Creating gem 'mygem'...
MIT License enabled in config
Code of conduct enabled in config
      create  mygem/Gemfile
      create  mygem/lib/mygem.rb
      create  mygem/lib/mygem/version.rb
      create  mygem/mygem.gemspec
      create  mygem/Rakefile
      create  mygem/README.md
      create  mygem/bin/console
      create  mygem/bin/setup
      create  mygem/.gitignore
      create  mygem/.travis.yml
      create  mygem/test/test_helper.rb
      create  mygem/test/mygem_test.rb
      create  mygem/LICENSE.txt
      create  mygem/CODE_OF_CONDUCT.md
</span></code></pre></div></div>
<p>  如果是第一次运行上面的命令，可能会进入一个交互式的界面让你确认一些选项。自己使用了比较保守的选择，创建一个 <code class="highlighter-rouge">lib</code> 的同时也会创建相应的 <code class="highlighter-rouge">test</code> 目录。</p>
<h4 id="修改-gemspec-文件">修改 <code class="highlighter-rouge">gemspec</code> 文件</h4>
<p>  这个文件描述了这个 Gem 的信息。</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'lib/mygem/version'</span>

<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">spec</span><span class="o">|</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">name</span>          <span class="o">=</span> <span class="s2">"mygem"</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">version</span>       <span class="o">=</span> <span class="no">Mygem</span><span class="o">::</span><span class="no">VERSION</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">authors</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">"TODO: Write your name"</span><span class="p">]</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">email</span>         <span class="o">=</span> <span class="p">[</span><span class="s2">"TODO: Write your email address"</span><span class="p">]</span>

  <span class="n">spec</span><span class="p">.</span><span class="nf">summary</span>       <span class="o">=</span> <span class="sx">%q{TODO: Write a short summary, because RubyGems requires one.}</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">description</span>   <span class="o">=</span> <span class="sx">%q{TODO: Write a longer description or delete this line.}</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">homepage</span>      <span class="o">=</span> <span class="s2">"TODO: Put your gem's website or public repo URL here."</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">license</span>       <span class="o">=</span> <span class="s2">"MIT"</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">required_ruby_version</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"&gt;= 2.3.0"</span><span class="p">)</span>

  <span class="n">spec</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="s2">"allowed_push_host"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"TODO: Set to 'http://mygemserver.com'"</span>

  <span class="n">spec</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="s2">"homepage_uri"</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">homepage</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="s2">"source_code_uri"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"TODO: Put your gem's public repo URL here."</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="s2">"changelog_uri"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"TODO: Put your gem's CHANGELOG.md URL here."</span>

  <span class="c1"># Specify which files should be added to the gem when it is released.</span>
  <span class="c1"># The `git ls-files -z` loads the files in the RubyGem that have been added into git.</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">files</span>         <span class="o">=</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'..'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">))</span> <span class="k">do</span>
    <span class="sb">`git ls-files -z`</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\x0</span><span class="s2">"</span><span class="p">).</span><span class="nf">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">%r{^(test|spec|features)/}</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">bindir</span>        <span class="o">=</span> <span class="s2">"exe"</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">executables</span>   <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">files</span><span class="p">.</span><span class="nf">grep</span><span class="p">(</span><span class="sr">%r{^exe/}</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">require_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"lib"</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>
<p>  凡是用 <code class="highlighter-rouge">TODO</code> 描述的地方，都是需要自行填写。</p>
<h4 id="编写自己的功能代码">编写自己的功能代码</h4>
<p>  自己的代码在 <code class="highlighter-rouge">lib/mygem.rb</code> 下实现：</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"mygem/version"</span>

<span class="k">module</span> <span class="nn">Mygem</span>
  <span class="k">class</span> <span class="nc">Error</span> <span class="o">&lt;</span> <span class="no">StandardError</span><span class="p">;</span> <span class="k">end</span>
  <span class="c1"># Your code goes here...</span>
  <span class="k">class</span> <span class="nc">HelloToSomeone</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">someone</span><span class="p">)</span>
      <span class="vi">@someone</span> <span class="o">=</span> <span class="n">someone</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">say</span><span class="p">()</span>
      <span class="nb">puts</span> <span class="s2">"Hello, </span><span class="si">#@someone</span><span class="s2">!"</span>
      <span class="k">return</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<h4 id="测试自己写的功能代码">测试自己写的功能代码</h4>
<p>  测试的代码在 <code class="highlighter-rouge">test/mygem_test.rb</code> 下实现：</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">MygemTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="k">def</span> <span class="nf">test_that_it_has_a_version_number</span>
    <span class="n">refute_nil</span> <span class="o">::</span><span class="no">Mygem</span><span class="o">::</span><span class="no">VERSION</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_my_hello_obj</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="o">::</span><span class="no">Mygem</span><span class="o">::</span><span class="no">HelloToSomeone</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
    <span class="n">refute_nil</span> <span class="n">obj</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">say</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>  编写好测试代码后在仓库的根目录下使用 <code class="highlighter-rouge">rake test</code> 来完成测试。</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>rake <span class="nb">test</span>
<span class="go">Run options: --seed 13840

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
Hello, world!
</span><span class="c">..
</span><span class="go">
Finished in 0.000653s, 3060.7857 runs/s, 3060.7857 assertions/s.

2 runs, 2 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre></div></div>
<h4 id="打包自己的-gem">打包自己的 gem</h4>
<p>  执行 <code class="highlighter-rouge">rake build</code> 来完成打包的操作：</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>rake build
<span class="go">mygem 0.1.0 built to pkg/mygem-0.1.0.gem.
</span></code></pre></div></div>
<h4 id="在本地安装这个-gem">在本地安装这个 gem</h4>
<p>  如果只是想在本地安装这个 gem 使用 <code class="highlighter-rouge">rake install</code> 命令：</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>rake <span class="nb">install</span>
<span class="go">mygem 0.1.0 built to pkg/mygem-0.1.0.gem.
mygem (0.1.0) installed.
</span></code></pre></div></div>
<h4 id="发布这个-gem-到远端">发布这个 gem 到远端</h4>
<p>  这里主要是指的是将这个 gem 包发布到 <code class="highlighter-rouge">https://rubygems.org</code> 上面，当然前提是需要在上面注册一个账号，因为发布的时候需要提交自己的账户密码，类似 github（不得不说，这样的方式是十分有利于社区的快速发展）。<br />
 <br />
  使用 <code class="highlighter-rouge">rake release</code> 命令：</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>rake release
<span class="go">mygem 0.1.0 built to pkg/mygem-0.1.0.gem.
Tagged v0.1.0.
Pushed git commits and tags.
Pushing gem to https://rubygems.org...
Successfully registered gem: mygem (0.1.0)
</span></code></pre></div></div>

<hr />

  </div><a class="u-url" href="/ruby/2019/12/18/record-ruby-tossing-history.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">A tossing programmer</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">A tossing programmer</li><li><a class="u-email" href="mailto:fuzhibo@tom.com">fuzhibo@tom.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/fuzhibo"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">fuzhibo</span></a></li><li><a href="https://www.twitter.com/fuzhibo"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">fuzhibo</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This blog documented my learing trajectory.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
