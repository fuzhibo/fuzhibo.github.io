<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>实现一个 python 版本的 Crond Service | A tossing programmer</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="实现一个 python 版本的 Crond Service" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="  在微服务的实践中，所有的应用都被打包成了容器。但是总会遇到一些作业定时调度的需求，在不知道有 APScheduler 的情况下通常的办法都会想到用 Linux 系统中自带的 Crond Service 来完成相应的作业调度功能。那么如果要将这部分的实现迁移到容器中来，大多数情况下会选择同时集成 Crond Service 到容器。这就破坏了一个进程一个容器的容器设计思想，并且在实际的运行过程中 Crond Service 的运行也不是足够的稳定。默认情况下 Crond Service 启动后，会自动在 /var/run/ 中创建一个 crond.pid 文件。如果为镜像新增了什么配置并且使用 docker commit 重新打包了之后，这个 crond.pid 文件也会被打包并会干扰到下次的容器启动或者 docker exec 的操作。     在知道了 APScheduler 后，一个办法是通过重构将原有的调度全部放到代码中，但是这种重构带来的问题是未来每次新增一个作业调度都要增加代码。无疑是大大的增加了服务开发的时间。另外一个办法是考虑实现一个 python 版本的 Crond Service 服务。     因为存在 python-crontab 这样的库，使用 python 管理 crontab 文件的复杂度被大大的降低，而同时结合 APScheduler 就可以实现一个 python 版本的 Crond Service 服务。 ```python import os import datetime import json import time import requests import traceback import hashlib from watchdog.observers import Observer from crontab import CronTab from watchdog.events import FileSystemEventHandler from threading import Thread, Event import queue as Queue from apscheduler.schedulers.background import BackgroundScheduler from cmop.common.log import info, warn, debug, error from cmop.common.rabbitmq_interface import RabbitmqService from cmop.common.utils import RedisClient, run_local_command, byteify" />
<meta property="og:description" content="  在微服务的实践中，所有的应用都被打包成了容器。但是总会遇到一些作业定时调度的需求，在不知道有 APScheduler 的情况下通常的办法都会想到用 Linux 系统中自带的 Crond Service 来完成相应的作业调度功能。那么如果要将这部分的实现迁移到容器中来，大多数情况下会选择同时集成 Crond Service 到容器。这就破坏了一个进程一个容器的容器设计思想，并且在实际的运行过程中 Crond Service 的运行也不是足够的稳定。默认情况下 Crond Service 启动后，会自动在 /var/run/ 中创建一个 crond.pid 文件。如果为镜像新增了什么配置并且使用 docker commit 重新打包了之后，这个 crond.pid 文件也会被打包并会干扰到下次的容器启动或者 docker exec 的操作。     在知道了 APScheduler 后，一个办法是通过重构将原有的调度全部放到代码中，但是这种重构带来的问题是未来每次新增一个作业调度都要增加代码。无疑是大大的增加了服务开发的时间。另外一个办法是考虑实现一个 python 版本的 Crond Service 服务。     因为存在 python-crontab 这样的库，使用 python 管理 crontab 文件的复杂度被大大的降低，而同时结合 APScheduler 就可以实现一个 python 版本的 Crond Service 服务。 ```python import os import datetime import json import time import requests import traceback import hashlib from watchdog.observers import Observer from crontab import CronTab from watchdog.events import FileSystemEventHandler from threading import Thread, Event import queue as Queue from apscheduler.schedulers.background import BackgroundScheduler from cmop.common.log import info, warn, debug, error from cmop.common.rabbitmq_interface import RabbitmqService from cmop.common.utils import RedisClient, run_local_command, byteify" />
<link rel="canonical" href="https://fuzhibo.site/python,crond/2019/12/18/implement-python-crond-service.html" />
<meta property="og:url" content="https://fuzhibo.site/python,crond/2019/12/18/implement-python-crond-service.html" />
<meta property="og:site_name" content="A tossing programmer" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-18T12:18:29+08:00" />
<script type="application/ld+json">
{"description":"  在微服务的实践中，所有的应用都被打包成了容器。但是总会遇到一些作业定时调度的需求，在不知道有 APScheduler 的情况下通常的办法都会想到用 Linux 系统中自带的 Crond Service 来完成相应的作业调度功能。那么如果要将这部分的实现迁移到容器中来，大多数情况下会选择同时集成 Crond Service 到容器。这就破坏了一个进程一个容器的容器设计思想，并且在实际的运行过程中 Crond Service 的运行也不是足够的稳定。默认情况下 Crond Service 启动后，会自动在 /var/run/ 中创建一个 crond.pid 文件。如果为镜像新增了什么配置并且使用 docker commit 重新打包了之后，这个 crond.pid 文件也会被打包并会干扰到下次的容器启动或者 docker exec 的操作。     在知道了 APScheduler 后，一个办法是通过重构将原有的调度全部放到代码中，但是这种重构带来的问题是未来每次新增一个作业调度都要增加代码。无疑是大大的增加了服务开发的时间。另外一个办法是考虑实现一个 python 版本的 Crond Service 服务。     因为存在 python-crontab 这样的库，使用 python 管理 crontab 文件的复杂度被大大的降低，而同时结合 APScheduler 就可以实现一个 python 版本的 Crond Service 服务。 ```python import os import datetime import json import time import requests import traceback import hashlib from watchdog.observers import Observer from crontab import CronTab from watchdog.events import FileSystemEventHandler from threading import Thread, Event import queue as Queue from apscheduler.schedulers.background import BackgroundScheduler from cmop.common.log import info, warn, debug, error from cmop.common.rabbitmq_interface import RabbitmqService from cmop.common.utils import RedisClient, run_local_command, byteify","mainEntityOfPage":{"@type":"WebPage","@id":"https://fuzhibo.site/python,crond/2019/12/18/implement-python-crond-service.html"},"@type":"BlogPosting","url":"https://fuzhibo.site/python,crond/2019/12/18/implement-python-crond-service.html","headline":"实现一个 python 版本的 Crond Service","datePublished":"2019-12-18T12:18:29+08:00","dateModified":"2019-12-18T12:18:29+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://fuzhibo.site/feed.xml" title="A tossing programmer" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">A tossing programmer</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">实现一个 python 版本的 Crond Service</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-12-18T12:18:29+08:00" itemprop="datePublished">Dec 18, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>  在微服务的实践中，所有的应用都被打包成了容器。但是总会遇到一些作业定时调度的需求，在不知道有 <code class="highlighter-rouge">APScheduler</code> 的情况下通常的办法都会想到用 Linux 系统中自带的 Crond Service 来完成相应的作业调度功能。那么如果要将这部分的实现迁移到容器中来，大多数情况下会选择同时集成 Crond Service 到容器。这就破坏了<code class="highlighter-rouge">一个进程一个容器</code>的容器设计思想，并且在实际的运行过程中 Crond Service 的运行也不是足够的稳定。默认情况下 Crond Service 启动后，会自动在 <code class="highlighter-rouge">/var/run/</code> 中创建一个 <code class="highlighter-rouge">crond.pid</code> 文件。如果为镜像新增了什么配置并且使用 <code class="highlighter-rouge">docker commit</code> 重新打包了之后，这个 <code class="highlighter-rouge">crond.pid</code> 文件也会被打包并会干扰到下次的容器启动或者 <code class="highlighter-rouge">docker exec</code> 的操作。<br />
 <br />
  在知道了 <code class="highlighter-rouge">APScheduler</code> 后，一个办法是通过重构将原有的调度全部放到代码中，但是这种重构带来的问题是未来每次新增一个作业调度都要增加代码。无疑是大大的增加了服务开发的时间。另外一个办法是考虑实现一个 python 版本的 Crond Service 服务。<br />
 <br />
  因为存在 <code class="highlighter-rouge">python-crontab</code> 这样的库，使用 python 管理 <code class="highlighter-rouge">crontab</code> 文件的复杂度被大大的降低，而同时结合 <code class="highlighter-rouge">APScheduler</code> 就可以实现一个 python 版本的 Crond Service 服务。</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">watchdog.observers</span> <span class="kn">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">crontab</span> <span class="kn">import</span> <span class="n">CronTab</span>
<span class="kn">from</span> <span class="nn">watchdog.events</span> <span class="kn">import</span> <span class="n">FileSystemEventHandler</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">queue</span> <span class="k">as</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">apscheduler.schedulers.background</span> <span class="kn">import</span> <span class="n">BackgroundScheduler</span>
<span class="kn">from</span> <span class="nn">cmop.common.log</span> <span class="kn">import</span> <span class="n">info</span><span class="p">,</span> <span class="n">warn</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">error</span>
<span class="kn">from</span> <span class="nn">cmop.common.rabbitmq_interface</span> <span class="kn">import</span> <span class="n">RabbitmqService</span>
<span class="kn">from</span> <span class="nn">cmop.common.utils</span> <span class="kn">import</span> <span class="n">RedisClient</span><span class="p">,</span> <span class="n">run_local_command</span><span class="p">,</span> <span class="n">byteify</span>

<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">"redis-master"</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">SYSTEM_CRONTAB</span> <span class="o">=</span> <span class="s">"/etc/crontab"</span>
<span class="n">CROND_SERVICE_PREFIX</span> <span class="o">=</span> <span class="s">"crond-service-cronjob-cache"</span>

<span class="n">MSGQUEUE</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="n">CROND_RESTART_EVENT</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SchedulerManagement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">scheduler_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">start_flag_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_prefix</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span> <span class="o">=</span> <span class="n">key_prefix</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Init scheduler: {self._scheduler_key_prefix}"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_flag</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">BackgroundScheduler</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
                <span class="n">job_defaults</span><span class="o">=</span><span class="p">{</span>
                    <span class="s">"coalesce"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">"max_instances"</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                    <span class="s">"misfire_grace_time"</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_jobstore</span><span class="p">(</span>
                <span class="s">"redis"</span><span class="p">,</span>
                <span class="n">jobs_key</span><span class="o">=</span><span class="s">"{0}.jobs"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">),</span>
                <span class="n">run_times_key</span><span class="o">=</span><span class="s">"{0}.run_times"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">),</span>
                <span class="n">host</span><span class="o">=</span><span class="s">"redis-master"</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Scheduler: {self._scheduler_key_prefix} has already started, ignore initialize..."</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">scheduler_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">scheduler_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">]</span>

    <span class="o">@</span><span class="n">scheduler</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="c1"># delete related instance
</span>            <span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Scheduler {self._scheduler_key_prefix} will be destroy..."</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">scheduler_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">]</span>
        <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">scheduler_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">start_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">start_flag_dict</span><span class="p">:</span>
            <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">start_flag_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">start_flag_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">]</span>

    <span class="o">@</span><span class="n">start_flag</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">start_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">SchedulerManagement</span><span class="o">.</span><span class="n">start_flag_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Start scheduler [</span><span class="si">%</span><span class="s">s]..."</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_flag</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_flag</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Stop scheduler..."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_send_schedule_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Begin to send scheduled notify..."</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">RabbitmqService</span><span class="p">()</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">error</span><span class="p">(</span><span class="s">"Failed to send data </span><span class="si">%</span><span class="s">r due to </span><span class="si">%</span><span class="s">r"</span> <span class="o">%</span> <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_common_notify_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">mon</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">dow</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_args</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"The job {jobid} has already exists, ignore..."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s">"Add notify callback..."</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
                <span class="n">cb</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">cb_args</span><span class="p">,</span>
                <span class="n">trigger</span><span class="o">=</span><span class="s">"cron"</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                <span class="n">hour</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                <span class="n">day</span><span class="o">=</span><span class="n">dom</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="n">mon</span><span class="p">,</span>
                <span class="n">day_of_week</span><span class="o">=</span><span class="n">dow</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_common_notify_callback_once</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">run_date</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_args</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Add once notify callback..."</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
            <span class="n">cb</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cb_args</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="s">"date"</span><span class="p">,</span> <span class="n">run_date</span><span class="o">=</span><span class="n">run_date</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">jobid</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_all_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">remove_all_jobs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">jobid</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">remove_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">remove_all_jobs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_schedule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">mon</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">dow</span><span class="o">=</span><span class="s">"*"</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_args</span><span class="o">=</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Add new scheduled job..."</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_schedule_notify</span>
        <span class="k">if</span> <span class="n">jobid</span><span class="p">:</span>
            <span class="n">redis_clt</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">redis_clt</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
                <span class="n">cb_args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">body</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_common_notify_callback</span><span class="p">(</span>
            <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="n">dom</span><span class="p">,</span> <span class="n">mon</span><span class="o">=</span><span class="n">mon</span><span class="p">,</span> <span class="n">dow</span><span class="o">=</span><span class="n">dow</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="n">cb_args</span><span class="o">=</span><span class="n">cb_args</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_schedule_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_date</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_args</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Add new once scheduled job..."</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_schedule_notify</span>
        <span class="k">if</span> <span class="n">jobid</span><span class="p">:</span>
            <span class="n">redis_clt</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">redis_clt</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_key_prefix</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
                <span class="n">cb_args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">body</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">run_date</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_common_notify_callback_once</span><span class="p">(</span>
                <span class="n">run_date</span><span class="o">=</span><span class="n">run_date</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="n">cb_args</span><span class="o">=</span><span class="n">cb_args</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s">"Failed to get schedule run date, ignore cron config..."</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CronTabEventHandler</span><span class="p">(</span><span class="n">FileSystemEventHandler</span><span class="p">):</span>
    <span class="s">"""Logs all the events captured."""</span>

    <span class="k">def</span> <span class="nf">on_moved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CronTabEventHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_moved</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">what</span> <span class="o">=</span> <span class="s">"directory"</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_directory</span> <span class="k">else</span> <span class="s">"file"</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">"Moved {what}: from {event.src_path} to {event.dest_path}"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CronTabEventHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">what</span> <span class="o">=</span> <span class="s">"directory"</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_directory</span> <span class="k">else</span> <span class="s">"file"</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">"Created {what}: {event.src_path}"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CronTabEventHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_deleted</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">what</span> <span class="o">=</span> <span class="s">"directory"</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_directory</span> <span class="k">else</span> <span class="s">"file"</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">"Deleted {what}: {event.src_path}"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CronTabEventHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_modified</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">redis_clt</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">is_directory</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span> <span class="o">==</span> <span class="n">SYSTEM_CRONTAB</span><span class="p">:</span>
            <span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">"Modified file: {event.src_path}"</span><span class="p">)</span>
            <span class="c1"># read the crontab file and set it to apscheduler
</span>            <span class="c1"># clean redis
</span>            <span class="n">redis_clt</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">CROND_SERVICE_PREFIX</span><span class="p">)</span>
            <span class="n">system_cron</span> <span class="o">=</span> <span class="n">CronTab</span><span class="p">(</span><span class="n">tabfile</span><span class="o">=</span><span class="n">SYSTEM_CRONTAB</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">cron_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">system_cron</span><span class="p">:</span>
                <span class="n">job_mark</span> <span class="o">=</span> <span class="n">f</span><span class="s">"{str(job.minute)},{str(job.hour)},{str(job.dom)},{str(job.month)},{str(job.dow)},{job.user},{job.command}"</span>
                <span class="n">jobid</span> <span class="o">=</span> <span class="n">f</span><span class="s">"crondServiceTask-{hashlib.md5(job_mark.encode('utf-8')).hexdigest()[8:-8]}"</span>
                <span class="n">MSGQUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">minute</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">dom</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">month</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">dow</span><span class="p">),</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">cron_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">minute</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">dom</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">month</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">dow</span><span class="p">),</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># record in redis
</span>                <span class="n">redis_clt</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">CROND_SERVICE_PREFIX</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cron_jobs</span><span class="p">))</span>
                <span class="c1"># clean current jobs and restart crond service
</span>                <span class="n">CROND_RESTART_EVENT</span><span class="o">.</span><span class="nb">set</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CrondService</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
    <span class="s">"""Start a thread run like crond service"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CrondService</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recovery_system_crontab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check the file has already existed
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SYSTEM_CRONTAB</span><span class="p">):</span>
            <span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"There is no related file {SYSTEM_CRONTAB}, will create one..."</span><span class="p">)</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">SYSTEM_CRONTAB</span><span class="p">,</span> <span class="s">"x"</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># recovery from redis and write to /etc/crontab
</span>        <span class="n">info</span><span class="p">(</span><span class="s">"Recovery crond setting from redis..."</span><span class="p">)</span>
        <span class="n">redis_clt</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">redis_clt</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CROND_SERVICE_PREFIX</span><span class="p">)</span>
        <span class="n">crond_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">byteify</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">crond_info</span><span class="p">:</span>
            <span class="n">system_cron</span> <span class="o">=</span> <span class="n">CronTab</span><span class="p">(</span><span class="n">tabfile</span><span class="o">=</span><span class="n">SYSTEM_CRONTAB</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cron</span> <span class="ow">in</span> <span class="n">crond_info</span><span class="p">:</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">dow</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">cron</span>
                <span class="n">job_mark</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">f</span><span class="s">"{str(m)},{str(h)},{str(dom)},{str(mon)},{str(dow)},{user},{cmd}"</span>
                <span class="p">)</span>
                <span class="n">jobid</span> <span class="o">=</span> <span class="n">f</span><span class="s">"crondServiceTask-{hashlib.md5(job_mark.encode('utf-8')).hexdigest()[8:-8]}"</span>
                <span class="n">newjob</span> <span class="o">=</span> <span class="n">system_cron</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">f</span><span class="s">"crond service {jobid}"</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span>
                <span class="p">)</span>
                <span class="n">newjob</span><span class="o">.</span><span class="n">setall</span><span class="p">(</span><span class="n">f</span><span class="s">"{str(m)} {str(h)} {str(dom)} {str(mon)} {str(dow)}"</span><span class="p">)</span>
                <span class="n">MSGQUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">dom</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">mon</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">dow</span><span class="p">),</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">cmd</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">system_cron</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="n">info</span><span class="p">(</span><span class="s">"Recovery crond setting completed."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s">"There is no related cron job record in cache, ignore recovery..."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Begin to start crond service monitor..."</span><span class="p">)</span>
        <span class="n">crond_tid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># recovery the cron job
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_system_crontab</span><span class="p">()</span>
        <span class="c1"># create a new thread to run crond service
</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">crond_tid</span><span class="p">:</span>
                <span class="n">crond_tid</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_crond_service_run</span><span class="p">)</span>
                <span class="n">crond_tid</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="c1"># try some counts to wait the thread alive
</span>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">crond_tid</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warn</span><span class="p">(</span><span class="s">"crond service thread is not ready, waitting.."</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s">"crond service can not be ready."</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">info</span><span class="p">(</span><span class="s">"Crond service started..."</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># monitor the event and restart the thread
</span>                <span class="n">CROND_RESTART_EVENT</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="c1"># restart the crond service
</span>                <span class="c1"># waith the thread stop
</span>                <span class="n">info</span><span class="p">(</span><span class="s">"Waitting for Crond service stop..."</span><span class="p">)</span>
                <span class="n">crond_tid</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="n">crond_tid</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">info</span><span class="p">(</span><span class="s">"Crond service stopped..."</span><span class="p">)</span>
                <span class="n">CROND_RESTART_EVENT</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s">"Crond service has quit..."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_crond_service_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">info</span><span class="p">(</span><span class="s">"Begin to start Crond Service..."</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">"/etc"</span>
        <span class="n">event_handler</span> <span class="o">=</span> <span class="n">CronTabEventHandler</span><span class="p">()</span>
        <span class="n">observer</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">()</span>
        <span class="n">info</span><span class="p">(</span><span class="s">"Begin to watch /etc/crontab file..."</span><span class="p">)</span>
        <span class="n">observer</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">event_handler</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">observer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">key_prefix</span> <span class="o">=</span> <span class="s">"crond_service_schedule"</span>
        <span class="n">sch_manage</span> <span class="o">=</span> <span class="n">SchedulerManagement</span><span class="p">(</span><span class="n">key_prefix</span><span class="o">=</span><span class="n">key_prefix</span><span class="p">)</span>
        <span class="n">sch_manage</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="c1"># remove all jobs
</span>        <span class="n">sch_manage</span><span class="o">.</span><span class="n">remove_job</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">msg_consumed</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get the crontab setting and set to
</span>                <span class="c1"># apscheduler
</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">MSGQUEUE</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">dow</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">MSGQUEUE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span>
                    <span class="p">)</span>
                    <span class="n">msg_consumed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">sch_manage</span><span class="o">.</span><span class="n">add_schedule</span><span class="p">(</span>
                        <span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">dow</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">run_local_command</span><span class="p">,</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># check the Event and decide if quit
</span>                    <span class="k">if</span> <span class="n">CROND_RESTART_EVENT</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">info</span><span class="p">(</span><span class="s">"Thread recive the quit event, will quite..."</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s">"Failed to run crond service scheduler manager due to {str(ex)}"</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg_consumed</span><span class="p">:</span>
                    <span class="n">MSGQUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

        <span class="n">observer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">observer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">sch_manage</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="c1"># start crond service
</span>    <span class="n">crond</span> <span class="o">=</span> <span class="n">CrondService</span><span class="p">(</span><span class="s">"crond-service"</span><span class="p">)</span>
    <span class="n">crond</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>
<p>  流程图如下：</p>

<script src="https://unpkg.com/mermaid@8.4.4/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
<div class="mermaid">
graph TD;
    A[Begin]--&gt;B[Recovery Crond Job];
    subgraph main_thread;
        B--&gt;C[Start Crond main Thread];
        C--&gt;D[Wait Crond restart event];
        D--restart event--&gt;E[Stop Crond main Thread];
        E--&gt;C;
    end;
    subgraph crond_thread;
        C--&gt;F[Start Watcher];
        F--&gt;G[Start Scheduler];
        G--&gt;H[Remove all jobs of Scheduler];
        H--&gt;I{Check job queue if empty};
        I--not empty--&gt;J[Get new job];
        J--&gt;K[Add new job to Scheduler];
        I--empty--&gt;K{Wait Crond restart event};
        K--restart event--&gt;L[Quit];
        K--timeout--&gt;I;
        L--stopped--&gt;E;
    end;
    subgraph watcher_thread;
        F--&gt;M[crontab file modified notify];
        M--&gt;N[send new to job queue];
        N--&gt;O[send restart event];
        O--send restart event--&gt;D;
    end;
    subgraph scheduler_thread;
        F--&gt;P[Trigger job];
    end;
</div>

  </div><a class="u-url" href="/python,crond/2019/12/18/implement-python-crond-service.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">A tossing programmer</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">A tossing programmer</li><li><a class="u-email" href="mailto:fuzhibo@tom.com">fuzhibo@tom.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/fuzhibo"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">fuzhibo</span></a></li><li><a href="https://www.twitter.com/fuzhibo"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">fuzhibo</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This blog documented my learing trajectory.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
